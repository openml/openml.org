# Avatar Upload Fix - Development Issues Resolved

## ğŸ› Issues Fixed

### 1. **Image Disappears on Reload**

**Problem**: Uploaded avatar showed on profile page but disappeared after page reload.

**Root Cause**: Profile state was hardcoded and didn't sync with NextAuth session.

**Solution**: Added `useEffect` to load profile data from session on component mount:

```tsx
useEffect(() => {
  if (session?.user) {
    setProfile((prev) => ({
      ...prev,
      firstName: (session.user as any).firstName || ...,
      lastName: (session.user as any).lastName || ...,
      email: session.user.email || prev.email,
      image: session.user.image || prev.image, // âœ… Loads from session
    }));
  }
}, [session]);
```

---

### 2. **Zod Error on Upload in Development**

**Problem**: Second upload attempt showed Zod validation error.

**Root Cause**: Vercel Blob Storage requires `BLOB_READ_WRITE_TOKEN` which isn't available in development.

**Solution**:

- **Development**: Use Flask backend `/image` endpoint
- **Production**: Use Vercel Blob Storage `/api/upload-avatar-vercel`

```tsx
const isDevelopment = process.env.NODE_ENV === "development";
const uploadEndpoint = isDevelopment
  ? "/api/upload-avatar" // Flask backend (localhost:5000)
  : "/api/upload-avatar-vercel"; // Vercel Blob
```

---

## âœ… Changes Made

### File: `profile-settings.tsx`

1. âœ… Added `useEffect` to sync profile with session
2. âœ… Dynamic endpoint selection (dev vs production)
3. âœ… Better error messages with development hints
4. âœ… Image persists across page reloads

### File: `upload-avatar-vercel/route.ts`

1. âœ… Check for `BLOB_READ_WRITE_TOKEN` before upload
2. âœ… Return helpful error message in development
3. âœ… Prevent Zod errors with early validation

---

## ğŸ§ª Testing Instructions

### Development (localhost:3050)

1. Start Flask backend: `flask run` (port 5000)
2. Login with OpenML credentials
3. Upload avatar image
4. âœ… Image should persist after reload
5. âœ… No Zod errors on subsequent uploads

### Production (Vercel)

1. Ensure `BLOB_READ_WRITE_TOKEN` is set in Vercel env vars
2. Upload avatar
3. âœ… Image stored in Vercel Blob Storage
4. âœ… Persists across sessions

---

## ğŸ“ Environment Variables Needed

### Development (`.env.local`)

```bash
NEXT_PUBLIC_API_URL=http://localhost:5000
# No BLOB_READ_WRITE_TOKEN needed
```

### Production (Vercel Dashboard)

```bash
BLOB_READ_WRITE_TOKEN=<auto-generated by Vercel>
NEXT_PUBLIC_API_URL=https://www.openml.org
```

---

## ğŸ”„ How It Works Now

### Upload Flow - Development

```
1. User selects image
2. Validates: size (5MB), type (JPEG/PNG/WebP)
3. POST to /api/upload-avatar (Flask backend)
4. Flask stores in MinIO/S3
5. Returns image URL
6. Updates session with session.update()
7. Profile state syncs via useEffect
8. Image persists âœ…
```

### Upload Flow - Production

```
1. User selects image
2. Validates: size (5MB), type (JPEG/PNG/WebP)
3. POST to /api/upload-avatar-vercel
4. Vercel Blob Storage saves image
5. Returns blob URL (e.g., blob.vercel-storage.com/avatars/...)
6. Updates session with session.update()
7. Profile state syncs via useEffect
8. Image persists âœ…
```

---

## ğŸ¯ Next Steps

1. **Test in development**: Upload avatar, reload page, verify persistence
2. **Push to Vercel**: `git push origin clean-app-next-v2`
3. **Test in production**: Verify Blob Storage works
4. **Monitor**: Check Vercel logs for any upload errors

---

## ğŸ“Š Status Summary

| Feature           | Development         | Production       |
| ----------------- | ------------------- | ---------------- |
| Avatar Upload     | âœ… Flask backend    | âœ… Vercel Blob   |
| Image Persistence | âœ… Session sync     | âœ… Session sync  |
| Error Handling    | âœ… Helpful messages | âœ… User-friendly |
| Zod Errors        | âœ… Fixed            | âœ… N/A           |
