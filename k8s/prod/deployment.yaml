apiVersion: apps/v1
kind: Deployment
metadata:
    name: openml-backend-prod
    namespace: openml-prod
    labels:
        app: openml-backend
        environment: production
spec:
    replicas: 3 # Multiple replicas for high availability
    strategy:
        type: RollingUpdate
        rollingUpdate:
            maxSurge: 1
            maxUnavailable: 0 # Zero downtime deployments

    selector:
        matchLabels:
            app: openml-backend
            environment: production

    template:
        metadata:
            labels:
                app: openml-backend
                environment: production
            annotations:
                prometheus.io/scrape: 'true'
                prometheus.io/port: '5000'
                prometheus.io/path: '/metrics'

        spec:
            # Pod anti-affinity - spread across nodes
            affinity:
                podAntiAffinity:
                    preferredDuringSchedulingIgnoredDuringExecution:
                        - weight: 100
                          podAffinityTerm:
                              labelSelector:
                                  matchExpressions:
                                      - key: app
                                        operator: In
                                        values:
                                            - openml-backend
                              topologyKey: kubernetes.io/hostname

            containers:
                - name: flask
                  image: your-registry/openml-flask:v1.0.0 # Update with your registry and version tag
                  imagePullPolicy: IfNotPresent
                  ports:
                      - containerPort: 5000
                        name: http
                        protocol: TCP

                  # Environment variables from ConfigMap
                  envFrom:
                      - configMapRef:
                            name: openml-backend-prod-config

                  # Sensitive data from Secrets
                  env:
                      - name: APP_SECRET_KEY
                        valueFrom:
                            secretKeyRef:
                                name: openml-backend-prod-secrets
                                key: APP_SECRET_KEY
                      - name: JWT_SECRET_KEY
                        valueFrom:
                            secretKeyRef:
                                name: openml-backend-prod-secrets
                                key: JWT_SECRET_KEY
                      - name: SMTP_PASS
                        valueFrom:
                            secretKeyRef:
                                name: openml-backend-prod-secrets
                                key: SMTP_PASS
                      - name: DATABASE_URI
                        valueFrom:
                            secretKeyRef:
                                name: openml-backend-prod-secrets
                                key: DATABASE_URI

                  # Health checks (production - more strict)
                  livenessProbe:
                      httpGet:
                          path: /health
                          port: 5000
                      initialDelaySeconds: 60
                      periodSeconds: 10
                      timeoutSeconds: 5
                      failureThreshold: 3

                  readinessProbe:
                      httpGet:
                          path: /health
                          port: 5000
                      initialDelaySeconds: 20
                      periodSeconds: 5
                      timeoutSeconds: 3
                      failureThreshold: 2

                  # Startup probe for slow-starting apps
                  startupProbe:
                      httpGet:
                          path: /health
                          port: 5000
                      initialDelaySeconds: 10
                      periodSeconds: 10
                      timeoutSeconds: 3
                      failureThreshold: 30 # 5 minutes to start

                  # Resource limits (production - higher resources)
                  resources:
                      requests:
                          cpu: '1'
                          memory: '2Gi'
                      limits:
                          cpu: '4'
                          memory: '8Gi'

                  # Security context
                  securityContext:
                      allowPrivilegeEscalation: false
                      runAsNonRoot: true
                      runAsUser: 1000
                      capabilities:
                          drop:
                              - ALL
                      readOnlyRootFilesystem: false # Set to true if possible

                  # Volume mounts
                  volumeMounts:
                      - name: cache
                        mountPath: /app/cache
                      - name: tmp
                        mountPath: /tmp

            volumes:
                - name: cache
                  emptyDir:
                      sizeLimit: 1Gi
                - name: tmp
                  emptyDir:
                      sizeLimit: 500Mi

---
apiVersion: v1
kind: Service
metadata:
    name: openml-backend-prod
    namespace: openml-prod
    labels:
        app: openml-backend
        environment: production
spec:
    type: ClusterIP
    ports:
        - port: 80
          targetPort: 5000
          protocol: TCP
          name: http
    selector:
        app: openml-backend
        environment: production
    sessionAffinity: ClientIP
    sessionAffinityConfig:
        clientIP:
            timeoutSeconds: 10800 # 3 hours

---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
    name: openml-backend-prod-hpa
    namespace: openml-prod
spec:
    scaleTargetRef:
        apiVersion: apps/v1
        kind: Deployment
        name: openml-backend-prod
    minReplicas: 3
    maxReplicas: 10
    metrics:
        - type: Resource
          resource:
              name: cpu
              target:
                  type: Utilization
                  averageUtilization: 70
        - type: Resource
          resource:
              name: memory
              target:
                  type: Utilization
                  averageUtilization: 80
    behavior:
        scaleDown:
            stabilizationWindowSeconds: 300
            policies:
                - type: Percent
                  value: 50
                  periodSeconds: 60
        scaleUp:
            stabilizationWindowSeconds: 0
            policies:
                - type: Percent
                  value: 100
                  periodSeconds: 30
                - type: Pods
                  value: 2
                  periodSeconds: 30
            selectPolicy: Max
